name: í”„ë¡œë•ì…˜ ë°°í¬

on:
  push:
    branches: [master, feat/https]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 15

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë°°í¬
        run: |
          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

          # ë°°í¬ ì‹¤í–‰
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸš€ ë°°í¬ ì‹œìž‘: $(date)"
            cd /opt/news-deliver

            # ì½”ë“œ ì—…ë°ì´íŠ¸
            git fetch origin && git checkout ${{ github.ref_name }} && git pull origin ${{ github.ref_name }}

            # í™˜ê²½ ì„¤ì • í™•ì¸
            [ ! -f ".env" ] && echo "âŒ .env íŒŒì¼ ì—†ìŒ" && exit 1

            # ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° ë³¼ë¥¨ ë³´ì¡´
            echo "ðŸ§¹ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker-compose down --remove-orphans --timeout 30 || true
            docker container prune -f || true
            docker image prune -f || true
            docker network prune -f || true

            # í•„ìˆ˜ ë³¼ë¥¨ ìƒì„±
            echo "ðŸ”§ ë³¼ë¥¨ ìƒì„±..."
            docker volume create news-deliver_redis-cache-data 2>/dev/null || true
            docker volume create news-deliver_es-data 2>/dev/null || true
            docker volume create news-deliver_es-plugins 2>/dev/null || true

            # ì„œë¹„ìŠ¤ ì‹œìž‘
            echo "ðŸš€ ì„œë¹„ìŠ¤ ì‹œìž‘..."
            docker-compose up -d --build

            # ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
            echo "â³ ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°..."
            sleep 90

            # Elasticsearch Nori í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜
            echo "ðŸ“¦ Nori í”ŒëŸ¬ê·¸ì¸ í™•ì¸..."
            if ! docker exec elasticsearch bin/elasticsearch-plugin list 2>/dev/null | grep -q "analysis-nori"; then
              echo "ì„¤ì¹˜ ì¤‘..."
              docker exec elasticsearch bin/elasticsearch-plugin install analysis-nori || true
              docker restart elasticsearch
              sleep 30
            fi

            echo "âœ… ë°°í¬ ì™„ë£Œ"
          '

      - name: í—¬ìŠ¤ì²´í¬
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
            docker ps --format "table {{.Names}}\t{{.Status}}"
          
            echo "ðŸ’¾ ë³¼ë¥¨ ìƒíƒœ"
            docker volume ls | grep news-deliver || echo "ë³¼ë¥¨ ì—†ìŒ"
          '

          # HTTPS í—¬ìŠ¤ì²´í¬
          echo "ðŸŒ HTTPS í—¬ìŠ¤ì²´í¬..."
          for i in {1..3}; do
            if curl -f https://api.likelionnews.click/api/hottopic >/dev/null 2>&1; then
              echo "âœ… Hot Topic API ì •ìƒ"
              break
            fi
            echo "ì‹œë„ $i/3 ì‹¤íŒ¨, 15ì´ˆ ëŒ€ê¸°..."
            sleep 15
          done

      - name: ë°°í¬ ìš”ì•½
        if: always()
        run: |
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒíƒœ**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëžœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ì„œë¹„ìŠ¤ ë§í¬" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: https://api.likelionnews.click" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¬¸ì„œ**: https://api.likelionnews.click/swagger.html" >> $GITHUB_STEP_SUMMARY
          echo "- **í•«í† í”½**: https://api.likelionnews.click/api/hottopic" >> $GITHUB_STEP_SUMMARY