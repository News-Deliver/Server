name: í”„ë¡œë•ì…˜ ë°°í¬ (HTTPS ëŒ€ì‘) - RDS ì‚¬ìš©

on:
  push:
    branches:
      - master
      - feat/https
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 25

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: í”„ë¡œë•ì…˜ ì„œë²„ì— ë°°í¬
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì‹œìž‘: $(date)"
          
            cd /opt/news-deliver
          
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin
            git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }} origin/${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
          
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f ".env" ]; then
              echo "âŒ .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
              exit 1
            fi
          
            # âœ… ë³¼ë¥¨ ìƒíƒœ í™•ì¸ (ë°°í¬ ì „) - MySQL ì œì™¸
            echo "ðŸ“Š ë°°í¬ ì „ ë³¼ë¥¨ ìƒíƒœ:"
            docker volume ls | grep -E "(es-data|redis)" || echo "ì¤‘ìš” ë³¼ë¥¨ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          
            # âœ… ì•ˆì „í•œ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ë³¼ë¥¨ ë³´ì¡´)
            echo "ðŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘ (ë³¼ë¥¨ì€ ì•ˆì „í•˜ê²Œ ë³´ì¡´)..."
            docker-compose down --remove-orphans --timeout 30 || true
          
            # âœ… ì„ íƒì  ì •ë¦¬ (ë³¼ë¥¨ì€ ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
            echo "ðŸ—‘ï¸ ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ë§Œ ì„ ë³„ ì •ë¦¬..."
            docker container prune -f || true  # ì •ì§€ëœ ì»¨í…Œì´ë„ˆë§Œ ì‚­ì œ
            docker image prune -f || true      # ëŒ•ê¸€ë§ ì´ë¯¸ì§€ë§Œ ì‚­ì œ
            docker network prune -f || true    # ì‚¬ìš©ì•ˆí•˜ëŠ” ë„¤íŠ¸ì›Œí¬ë§Œ ì‚­ì œ
          
            # âŒ docker system prune -f ì™„ì „ ì œê±°! (ë³¼ë¥¨ ì‚­ì œì˜ ì£¼ë²”)
            # ì´ì „: docker system prune -f || true  â† ì´ ëª…ë ¹ì–´ê°€ ë³¼ë¥¨ì„ ì‚­ì œí–ˆìŒ
          
            # âœ… ì •ë¦¬ í›„ ë³¼ë¥¨ ìƒíƒœ ìž¬í™•ì¸ - MySQL ì œì™¸
            echo "ðŸ“Š ì •ë¦¬ í›„ ë³¼ë¥¨ ìƒíƒœ (ë³´ì¡´ë˜ì–´ì•¼ í•¨):"
            docker volume ls | grep -E "(es-data|redis)" || echo "âš ï¸ ì¤‘ìš” ë³¼ë¥¨ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤!"
          
            # âœ… í•„ìš”í•œ ë³¼ë¥¨ ìƒì„± (ì—†ëŠ” ê²½ìš°ë§Œ)
            echo "ðŸ”§ í•„ìš”í•œ ë³¼ë¥¨ í™•ì¸ ë° ìƒì„±..."
            docker volume create news-deliver_redis-cache-data 2>/dev/null || echo "redis-cache-data ë³¼ë¥¨ ì´ë¯¸ ì¡´ìž¬"
            docker volume create news-deliver_es-plugins 2>/dev/null || echo "es-plugins ë³¼ë¥¨ ì´ë¯¸ ì¡´ìž¬"
          
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œìž‘
            echo "ðŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œìž‘ ì¤‘ (ê¸°ì¡´ ë³¼ë¥¨ ìž¬ì‚¬ìš©)..."
            docker-compose up -d --build
          
            echo "â³ ì»¨í…Œì´ë„ˆ ì‹œìž‘ ëŒ€ê¸° (90ì´ˆ)..."
            sleep 90
          
            # âœ… ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ í”ŒëŸ¬ê·¸ì¸ í™•ì¸ ë° ìžë™ ì„¤ì¹˜
            echo "ðŸ” Elasticsearch í”ŒëŸ¬ê·¸ì¸ ìƒíƒœ í™•ì¸..."
            if ! docker exec elasticsearch bin/elasticsearch-plugin list 2>/dev/null | grep -q "analysis-nori"; then
              echo "ðŸ“¦ Nori í”ŒëŸ¬ê·¸ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
              docker exec elasticsearch bin/elasticsearch-plugin install analysis-nori || echo "í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì‹¤íŒ¨"
              echo "ðŸ”„ Elasticsearch ìž¬ì‹œìž‘..."
              docker restart elasticsearch
              sleep 30
            else
              echo "âœ… Nori í”ŒëŸ¬ê·¸ì¸ì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìžˆìŠµë‹ˆë‹¤"
            fi
          
            # âœ… ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ìƒíƒœ í™•ì¸
            echo "ðŸ“Š Elasticsearch í´ëŸ¬ìŠ¤í„° ìƒíƒœ:"
            docker exec elasticsearch curl -s "localhost:9200/_cluster/health?pretty" | head -10 || echo "ES ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
          
            # âœ… ì¸ë±ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ðŸ“‘ ì¸ë±ìŠ¤ ìƒíƒœ í™•ì¸:"
            docker exec elasticsearch curl -s "localhost:9200/_cat/indices?v" || echo "ì¸ë±ìŠ¤ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨"
          
            echo "ðŸŽ‰ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ (RDS ì‚¬ìš©, ë³¼ë¥¨ ë³´ì¡´ë¨)"
          '

      - name: ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
            cd /opt/news-deliver
          
            echo "=== Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
            echo "=== ë³¼ë¥¨ ìƒíƒœ (ì¤‘ìš”!) - MySQL ì œì™¸ ==="
            docker volume ls | grep -E "(es-data|redis)" || echo "âš ï¸ ì¤‘ìš” ë³¼ë¥¨ì´ ì—†ìŠµë‹ˆë‹¤"
          
            echo "=== Spring Boot ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 30ì¤„) ==="
            SPRINGBOOT_CONTAINER=$(docker ps -q --filter "name=springboot")
            if [ ! -z "$SPRINGBOOT_CONTAINER" ]; then
              docker logs $SPRINGBOOT_CONTAINER --tail=30
            else
              echo "âŒ Spring Boot ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤"
            fi
          
            echo "=== ì£¼ìš” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ==="
            # RDS ì—°ê²° í™•ì¸ (Spring Boot ë¡œê·¸ë¥¼ í†µí•´)
            echo "ðŸ”Œ RDS ì—°ê²° ìƒíƒœ í™•ì¸:"
            if [ ! -z "$SPRINGBOOT_CONTAINER" ]; then
              docker logs $SPRINGBOOT_CONTAINER 2>&1 | grep -i "database\|connection\|rds" | tail -5 && echo "  ðŸ“Š RDS ì—°ê²° ë¡œê·¸ í™•ì¸ë¨" || echo "  âš ï¸ RDS ì—°ê²° ë¡œê·¸ ì—†ìŒ (ì •ìƒì¼ ìˆ˜ ìžˆìŒ)"
            fi
          
            # Redis í™•ì¸  
            if docker ps | grep -q redis; then
              echo "âœ… Redis ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
              docker exec redis-cache redis-cli ping 2>/dev/null && echo "  ðŸ’¾ Redis Cache ì—°ê²° ì •ìƒ" || echo "  âŒ Redis Cache ì—°ê²° ì‹¤íŒ¨"
            else
              echo "âŒ Redis ì»¨í…Œì´ë„ˆ ì—†ìŒ"
            fi
          
            # Elasticsearch í™•ì¸
            if docker ps | grep -q elasticsearch; then
              echo "âœ… Elasticsearch ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘"
              echo "ðŸ“Š Elasticsearch í´ëŸ¬ìŠ¤í„° ìƒíƒœ:"
              docker exec elasticsearch curl -s -X GET "localhost:9200/_cluster/health?pretty" | head -10 || echo "ES ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
              echo "ðŸ“‘ ì¸ë±ìŠ¤ ëª©ë¡:"
              docker exec elasticsearch curl -s -X GET "localhost:9200/_cat/indices?v" || echo "ì¸ë±ìŠ¤ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨"
              echo "ðŸ”Œ ì„¤ì¹˜ëœ í”ŒëŸ¬ê·¸ì¸:"
              docker exec elasticsearch bin/elasticsearch-plugin list 2>/dev/null | grep nori && echo "  âœ… Nori í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ë¨" || echo "  âŒ Nori í”ŒëŸ¬ê·¸ì¸ ì—†ìŒ"
            else
              echo "âŒ Elasticsearch ì»¨í…Œì´ë„ˆ ì—†ìŒ"
            fi
          '

      - name: ë‚´ë¶€ í—¬ìŠ¤ì²´í¬
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸ¥ ë‚´ë¶€ í—¬ìŠ¤ì²´í¬ ì‹œìž‘"
          
            # Spring Boot ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ìžê°€ í…ŒìŠ¤íŠ¸
            SPRINGBOOT_CONTAINER=$(docker ps -q --filter "name=springboot")
            if [ ! -z "$SPRINGBOOT_CONTAINER" ]; then
              echo "Spring Boot ë‚´ë¶€ í—¬ìŠ¤ì²´í¬:"
              docker exec $SPRINGBOOT_CONTAINER curl -f http://localhost:8080/api/auth/status 2>/dev/null && echo "âœ… ë‚´ë¶€ API ì •ìƒ (RDS ì—°ê²° í¬í•¨)" || echo "âŒ ë‚´ë¶€ API ì‹¤íŒ¨ (RDS ì—°ê²° ë¬¸ì œ ê°€ëŠ¥ì„±)"
            fi
          
            # í˜¸ìŠ¤íŠ¸ì—ì„œ ì»¨í…Œì´ë„ˆë¡œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
            echo "í˜¸ìŠ¤íŠ¸ì—ì„œ ì»¨í…Œì´ë„ˆ ì ‘ê·¼ í…ŒìŠ¤íŠ¸:"
            curl -f http://localhost:8080/api/auth/status 2>/dev/null && echo "âœ… í˜¸ìŠ¤íŠ¸->ì»¨í…Œì´ë„ˆ ì •ìƒ" || echo "âŒ í˜¸ìŠ¤íŠ¸->ì»¨í…Œì´ë„ˆ ì‹¤íŒ¨"
          
            # âœ… HotTopic API í…ŒìŠ¤íŠ¸ (ElasticSearch ì˜ì¡´)
            echo "HotTopic API í…ŒìŠ¤íŠ¸ (ElasticSearch ì˜ì¡´ì„±):"
            curl -f http://localhost:8080/api/hottopic 2>/dev/null && echo "âœ… HotTopic API ì •ìƒ (ES ì¸ë±ìŠ¤ ìœ ì§€ë¨)" || echo "âŒ HotTopic API ì‹¤íŒ¨ (ES ë¬¸ì œ ê°€ëŠ¥ì„±)"
          '

      - name: ìµœì¢… HTTPS í—¬ìŠ¤ì²´í¬
        run: |
          echo "ðŸŽ¯ HTTPS ë„ë©”ì¸ í—¬ìŠ¤ì²´í¬..."
          
          success=false
          api_domain="https://api.likelionnews.click"
          
          for attempt in {1..5}; do
            echo "ðŸ”„ ì‹œë„ $attempt/5"
          
            # HTTPS ë„ë©”ì¸ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
            endpoints=("/api/auth/status" "/api/hottopic" "/swagger.html")
          
            for endpoint in "${endpoints[@]}"; do
              url="${api_domain}${endpoint}"
              echo "  ðŸ“¡ í…ŒìŠ¤íŠ¸: $url"
          
              response=$(curl -s -o /dev/null -w "%{http_code}:%{time_total}" --connect-timeout 10 --max-time 20 "$url" || echo "000:0")
              http_code=$(echo $response | cut -d: -f1)
              time_total=$(echo $response | cut -d: -f2)
          
              echo "  ðŸ“Š ì‘ë‹µ: ì½”ë“œ=$http_code, ì‹œê°„=${time_total}s"
          
              if [ "$http_code" = "200" ]; then
                echo "  âœ… $endpoint ì„±ê³µ!"
                if [ "$endpoint" = "/api/hottopic" ]; then
                  echo "  ðŸŽ‰ ElasticSearch ì¸ë±ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
                fi
                if [ "$endpoint" = "/api/auth/status" ]; then
                  echo "  ðŸŽ‰ RDS ì—°ê²°ì´ ì •ìƒì ìœ¼ë¡œ ìž‘ë™í•©ë‹ˆë‹¤!"
                fi
                success=true
                break 2
              elif [ "$http_code" = "404" ]; then
                echo "  âš ï¸ $endpoint 404 (ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ì„ ìˆ˜ ìžˆìŒ)"
              elif [ "$http_code" = "000" ]; then
                echo "  âŒ $endpoint ì—°ê²° ì‹¤íŒ¨ (DNS/ALB ë¬¸ì œ ê°€ëŠ¥ì„±)"
              else
                echo "  âŒ $endpoint HTTP $http_code ì˜¤ë¥˜"
              fi
            done
          
            if [ $attempt -lt 5 ]; then
              echo "  â³ 15ì´ˆ ëŒ€ê¸°..."
              sleep 15
            fi
          done
          
          if [ "$success" = true ]; then
            echo "ðŸŽ‰ HTTPS ë°°í¬ ì„±ê³µ!"
            echo "ðŸ”— API ì„œë¹„ìŠ¤: https://api.likelionnews.click"
            echo "ðŸ“‹ API ë¬¸ì„œ: https://api.likelionnews.click/swagger.html"
            echo "ðŸ©º ìƒíƒœ í™•ì¸: https://api.likelionnews.click/api/auth/status"
            echo "ðŸ”¥ í•«í† í”½: https://api.likelionnews.click/api/hottopic"
            echo "ðŸ’¾ ë°ì´í„°ë² ì´ìŠ¤: AWS RDS ì—°ê²°"
          else
            echo "âš ï¸ HTTPS í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            echo "ðŸ”§ í™•ì¸ì‚¬í•­:"
            echo "  - Route53ì—ì„œ api.likelionnews.clickì´ ALBë¥¼ ê°€ë¦¬í‚¤ëŠ”ì§€ í™•ì¸"
            echo "  - ALBì— SSL ì¸ì¦ì„œê°€ ì •ìƒ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸"
            echo "  - ALB Target Groupì´ healthy ìƒíƒœì¸ì§€ í™•ì¸"
            echo "  - EC2 Security Groupì—ì„œ ALB â†’ EC2:8080 í—ˆìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸"
            echo "  - RDS Security Groupì—ì„œ EC2 â†’ RDS:3306 í—ˆìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸"
            echo "  - Elasticsearch í´ëŸ¬ìŠ¤í„° ìƒíƒœ ë° ì¸ë±ìŠ¤ í™•ì¸"
            echo "  - Nori í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ìƒíƒœ í™•ì¸"
          fi

      - name: ë°°í¬ ìš”ì•½
        if: always()
        run: |
          echo "## ðŸš€ HTTPS ë°°í¬ ìš”ì•½ - RDS ì‚¬ìš©" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒíƒœ**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëžœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°ì´í„°ë² ì´ìŠ¤**: ðŸ—„ï¸ AWS RDS (Docker MySQL ì œê±°)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë³¼ë¥¨**: ðŸ›¡ï¸ ElasticSearch/Redis ë³¼ë¥¨ ë³´ì¡´ë¨" >> $GITHUB_STEP_SUMMARY
          echo "- **ElasticSearch**: ðŸ“Š ì¸ë±ìŠ¤ ë° Nori í”ŒëŸ¬ê·¸ì¸ ìžë™ ê´€ë¦¬" >> $GITHUB_STEP_SUMMARY
          echo "- **Redis**: ðŸ’¾ ìºì‹œ ë°ì´í„° ì˜êµ¬ ë³´ì¡´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— HTTPS ë§í¬ë“¤:" >> $GITHUB_STEP_SUMMARY
          echo "- **API ì„œë¹„ìŠ¤**: https://api.likelionnews.click" >> $GITHUB_STEP_SUMMARY
          echo "- **API ë¬¸ì„œ**: https://api.likelionnews.click/swagger.html" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒíƒœ í™•ì¸**: https://api.likelionnews.click/api/auth/status" >> $GITHUB_STEP_SUMMARY
          echo "- **í•«í† í”½**: https://api.likelionnews.click/api/hottopic" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›  ë¬¸ì œ í•´ê²°:" >> $GITHUB_STEP_SUMMARY
          echo "1. \`ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. \`cd /opt/news-deliver && docker ps\`" >> $GITHUB_STEP_SUMMARY
          echo "3. \`docker logs springboot\` (ì»¨í…Œì´ë„ˆëª… í™•ì¸ í›„)" >> $GITHUB_STEP_SUMMARY
          echo "4. \`docker volume ls | grep -E \"(es-data|redis)\"\`" >> $GITHUB_STEP_SUMMARY
          echo "5. \`docker exec elasticsearch curl localhost:9200/_cat/indices\`" >> $GITHUB_STEP_SUMMARY
          echo "6. ALBì™€ Route53 ì„¤ì • í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "7. RDS ì—°ê²° ë° ë³´ì•ˆ ê·¸ë£¹ í™•ì¸" >> $GITHUB_STEP_SUMMARY