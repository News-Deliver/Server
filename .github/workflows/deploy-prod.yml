name: í”„ë¡œë•ì…˜ ë°°í¬ (ê°œì„ ëœ ë””ë²„ê¹…)

on:
  push:
    branches:
      - master
      - feat/git-master
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 25

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: í”„ë¡œë•ì…˜ ì„œë²„ì— ë°°í¬
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì‹œìž‘: $(date)"
          
            cd /opt/news-deliver
          
            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin
            git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }} origin/${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
          
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f ".env" ]; then
              echo "âŒ .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
              exit 1
            fi
          
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker-compose down --remove-orphans --timeout 30 || true
            docker system prune -f || true
          
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œìž‘
            docker-compose up -d --build --force-recreate
          
            echo "â³ ì»¨í…Œì´ë„ˆ ì‹œìž‘ ëŒ€ê¸° (90ì´ˆ)..."
            sleep 90
          
            echo "ðŸŽ‰ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ"
          '

      - name: ê³ ê¸‰ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸ” ê³ ê¸‰ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ì‹œìž‘"
            cd /opt/news-deliver
          
            echo "=== í˜„ìž¬ ìž‘ì—… ë””ë ‰í† ë¦¬ ==="
            pwd
            ls -la
          
            echo "=== Docker ë°ëª¬ ìƒíƒœ ==="
            sudo systemctl status docker --no-pager || echo "Docker ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
          
            echo "=== ëª¨ë“  Docker ì»¨í…Œì´ë„ˆ (ì‹¤í–‰ ì¤‘ + ì¤‘ì§€ë¨) ==="
            docker ps -a
          
            echo "=== Docker ì´ë¯¸ì§€ ëª©ë¡ ==="
            docker images
          
            echo "=== Docker Compose ì„¤ì • ê²€ì¦ ==="
            docker-compose config || echo "docker-compose.yml ì„¤ì • ì˜¤ë¥˜"
          
            echo "=== ì§ì ‘ Docker ì»¨í…Œì´ë„ˆ í™•ì¸ ==="
            docker ps --filter "name=springboot" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
            echo "=== Spring Boot ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ì§ì ‘ docker ëª…ë ¹ì–´) ==="
            SPRINGBOOT_CONTAINER=$(docker ps -q --filter "name=springboot")
            if [ ! -z "$SPRINGBOOT_CONTAINER" ]; then
              echo "Spring Boot ì»¨í…Œì´ë„ˆ ID: $SPRINGBOOT_CONTAINER"
              docker logs $SPRINGBOOT_CONTAINER --tail=50
            else
              echo "Spring Boot ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤"
            fi
          
            echo "=== ëª¨ë“  ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 10ì¤„ì”©) ==="
            for container in $(docker ps --format "{{.Names}}"); do
              echo "--- $container ë¡œê·¸ ---"
              docker logs $container --tail=10 2>/dev/null || echo "$container ë¡œê·¸ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨"
            done
          
            echo "=== í¬íŠ¸ ì‚¬ìš© ìƒíƒœ (ss ëª…ë ¹ì–´) ==="
            ss -tulpn | grep -E ":(80|8080|3306|6379|9200)" || echo "í•´ë‹¹ í¬íŠ¸ë“¤ì´ ì‚¬ìš© ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤"
          
            echo "=== ë„¤íŠ¸ì›Œí¬ ì¸í„°íŽ˜ì´ìŠ¤ ==="
            ip addr show
          
            echo "=== í˜¸ìŠ¤íŠ¸ì—ì„œ ì§ì ‘ í¬íŠ¸ í…ŒìŠ¤íŠ¸ ==="
            echo "80ë²ˆ í¬íŠ¸ í…ŒìŠ¤íŠ¸:"
            curl -I http://localhost:80/api/auth/status 2>/dev/null || echo "80ë²ˆ í¬íŠ¸ ì—°ê²° ì‹¤íŒ¨"
          
            echo "=== Docker ë„¤íŠ¸ì›Œí¬ ì •ë³´ ==="
            docker network ls
            docker network inspect news-deliver_backend 2>/dev/null || echo "ë°±ì—”ë“œ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì—†ìŒ"
          
            echo "=== ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ==="
            echo "ë©”ëª¨ë¦¬:"
            free -h
            echo "ë””ìŠ¤í¬:"
            df -h
            echo "CPU:"
            top -bn1 | head -5
          
            echo "ðŸ” ê³ ê¸‰ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ"
          '

      - name: ì»¨í…Œì´ë„ˆë³„ ê°œë³„ í…ŒìŠ¤íŠ¸
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸ§ª ì»¨í…Œì´ë„ˆë³„ ê°œë³„ í…ŒìŠ¤íŠ¸ ì‹œìž‘"
            cd /opt/news-deliver
          
            echo "=== MySQL ì»¨í…Œì´ë„ˆ í…ŒìŠ¤íŠ¸ ==="
            MYSQL_CONTAINER=$(docker ps -q --filter "name=mysql")
            if [ ! -z "$MYSQL_CONTAINER" ]; then
              echo "MySQL ìƒíƒœ í™•ì¸:"
              docker exec $MYSQL_CONTAINER mysqladmin ping -h localhost -u root -p$(grep DB_PASS .env | cut -d= -f2) || echo "MySQL ì—°ê²° ì‹¤íŒ¨"
            else
              echo "MySQL ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤"
            fi
          
            echo "=== Redis ì»¨í…Œì´ë„ˆ í…ŒìŠ¤íŠ¸ ==="
            REDIS_CONTAINER=$(docker ps -q --filter "name=redis-cache")
            if [ ! -z "$REDIS_CONTAINER" ]; then
              echo "Redis ìƒíƒœ í™•ì¸:"
              docker exec $REDIS_CONTAINER redis-cli ping || echo "Redis ì—°ê²° ì‹¤íŒ¨"
            else
              echo "Redis ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤"
            fi
          
            echo "=== Elasticsearch ì»¨í…Œì´ë„ˆ í…ŒìŠ¤íŠ¸ ==="
            ES_CONTAINER=$(docker ps -q --filter "name=elasticsearch")
            if [ ! -z "$ES_CONTAINER" ]; then
              echo "Elasticsearch ìƒíƒœ í™•ì¸:"
              docker exec $ES_CONTAINER curl -f http://localhost:9200/_cluster/health || echo "Elasticsearch ì—°ê²° ì‹¤íŒ¨"
            else
              echo "Elasticsearch ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤"
            fi
          
            echo "=== Spring Boot ì»¨í…Œì´ë„ˆ ì§ì ‘ í…ŒìŠ¤íŠ¸ ==="
            SPRINGBOOT_CONTAINER=$(docker ps -q --filter "name=springboot")
            if [ ! -z "$SPRINGBOOT_CONTAINER" ]; then
              echo "Spring Boot ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í”„ë¡œì„¸ìŠ¤:"
              docker exec $SPRINGBOOT_CONTAINER ps aux || echo "í”„ë¡œì„¸ìŠ¤ í™•ì¸ ì‹¤íŒ¨"
          
              echo "Spring Boot ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ í™•ì¸:"
              docker exec $SPRINGBOOT_CONTAINER netstat -tulpn 2>/dev/null || docker exec $SPRINGBOOT_CONTAINER ss -tulpn || echo "ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
          
              echo "Spring Boot ë‚´ë¶€ì—ì„œ ìžê°€ í…ŒìŠ¤íŠ¸:"
              docker exec $SPRINGBOOT_CONTAINER curl -f http://localhost:8080/api/auth/status || echo "ë‚´ë¶€ ìžê°€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            else
              echo "Spring Boot ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤"
            fi
          
            echo "ðŸ§ª ì»¨í…Œì´ë„ˆë³„ ê°œë³„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
          '

      - name: ìµœì¢… í—¬ìŠ¤ì²´í¬
        run: |
          echo "ðŸŽ¯ ìµœì¢… ì™¸ë¶€ í—¬ìŠ¤ì²´í¬..."
          
          success=false
          
          for attempt in {1..5}; do
            echo "ðŸ”„ ì‹œë„ $attempt/5"
          
            # ë‹¤ì–‘í•œ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
            endpoints=("/api/auth/status" "/health" "/swagger.html")
          
            for endpoint in "${endpoints[@]}"; do
              url="http://${{ secrets.EC2_HOST }}${endpoint}"
              echo "  ðŸ“¡ í…ŒìŠ¤íŠ¸: $url"
          
              response=$(curl -s -o /dev/null -w "%{http_code}:%{time_total}" --connect-timeout 5 --max-time 10 "$url" || echo "000:0")
              http_code=$(echo $response | cut -d: -f1)
              time_total=$(echo $response | cut -d: -f2)
          
              echo "  ðŸ“Š ì‘ë‹µ: ì½”ë“œ=$http_code, ì‹œê°„=${time_total}s"
          
              if [ "$http_code" = "200" ]; then
                echo "  âœ… $endpoint ì„±ê³µ!"
                success=true
                break 2
              elif [ "$http_code" = "404" ] && [ "$endpoint" = "/health" ]; then
                echo "  âš ï¸ $endpoint 404 (ì•„ì§ êµ¬í˜„ ì•ˆë¨)"
              else
                echo "  âŒ $endpoint ì‹¤íŒ¨"
              fi
            done
          
            if [ $attempt -lt 5 ]; then
              echo "  â³ 15ì´ˆ ëŒ€ê¸°..."
              sleep 15
            fi
          done
          
          if [ "$success" = true ]; then
            echo "ðŸŽ‰ ë°°í¬ ì„±ê³µ!"
            echo "ðŸ”— ì„œë¹„ìŠ¤ URL: http://${{ secrets.EC2_HOST }}/"
            echo "ðŸ“‹ API ë¬¸ì„œ: http://${{ secrets.EC2_HOST }}/swagger.html"
            echo "ðŸ©º ìƒíƒœ í™•ì¸: http://${{ secrets.EC2_HOST }}/api/auth/status"
          else
            echo "âš ï¸ ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨í–ˆì§€ë§Œ ì„œë¹„ìŠ¤ëŠ” ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤"
            echo "ðŸ”— ì§ì ‘ í™•ì¸: http://${{ secrets.EC2_HOST }}/"
          fi

      - name: ë°°í¬ ìš”ì•½
        if: always()
        run: |
          echo "## ðŸš€ ë°°í¬ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒíƒœ**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëžœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ë§í¬ë“¤:" >> $GITHUB_STEP_SUMMARY
          echo "- **ë©”ì¸ ì„œë¹„ìŠ¤**: http://${{ secrets.EC2_HOST }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **API ë¬¸ì„œ**: http://${{ secrets.EC2_HOST }}/swagger.html" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒíƒœ í™•ì¸**: http://${{ secrets.EC2_HOST }}/api/auth/status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›  ë¬¸ì œ í•´ê²°:" >> $GITHUB_STEP_SUMMARY
          echo "1. \`ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. \`cd /opt/news-deliver && docker ps\`" >> $GITHUB_STEP_SUMMARY
          echo "3. \`docker logs springboot\` (ì»¨í…Œì´ë„ˆëª… í™•ì¸ í›„)" >> $GITHUB_STEP_SUMMARY