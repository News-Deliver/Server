name: Deploy to AWS EC2

on:
  push:
    branches: [ main, 'feat/**' ]  # feat ë¸Œëžœì¹˜ë„ í¬í•¨ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸš€ Starting deployment at $(date)"
            echo "ðŸ“ Branch: ${{ github.ref_name }}"
          
            cd /opt/news-deliver
          
            # í˜„ìž¬ ë¸Œëžœì¹˜ í™•ì¸
            echo "ðŸ“‹ Current branch: $(git branch --show-current)"
          
            # í•´ë‹¹ ë¸Œëžœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ ë° í’€
            echo "ðŸ“¥ Pulling latest code from ${{ github.ref_name }}..."
            git fetch origin
            git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }} origin/${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
          
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f ".env" ]; then
              echo "âŒ .env file not found!"
              exit 1
            fi
          
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            echo "ðŸ›‘ Stopping existing containers..."
            docker-compose down || true
          
            # Docker ì´ë¯¸ì§€ ì •ë¦¬
            echo "ðŸ§¹ Cleaning up old images..."
            docker system prune -f
          
            # ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹œìž‘
            echo "ðŸ”„ Starting new containers..."
            docker-compose up -d --build
          
            # ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸°
            echo "â³ Waiting for services to start..."
            sleep 60
          
            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ðŸ“Š Checking service status..."
            docker-compose ps
          
            # Spring Boot í—¬ìŠ¤ì²´í¬
            echo "ðŸ” Health checking Spring Boot..."
            for i in {1..12}; do
              if curl -f http://localhost:8080/ >/dev/null 2>&1; then
                echo "âœ… Spring Boot is healthy!"
                break
              fi
              echo "â³ Attempt $i/12: Spring Boot not ready yet..."
              sleep 10
            done
          
            echo "ðŸŽ‰ Deployment completed at $(date)"
          '

      - name: External Health Check
        run: |
          echo "ðŸ” External health check..."
          sleep 30
          
          # ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸
          for i in {1..5}; do
            if curl -f http://${{ secrets.EC2_HOST }}/ >/dev/null 2>&1; then
              echo "âœ… External health check passed!"
              echo "ðŸ”— Application URL: http://${{ secrets.EC2_HOST }}/"
              echo "ðŸ“‹ API Docs: http://${{ secrets.EC2_HOST }}/swagger.html"
              echo "ðŸŒ¿ Deployed from branch: ${{ github.ref_name }}"
              exit 0
            fi
            echo "â³ Attempt $i/5: External check not ready yet..."
            sleep 10
          done
          
          echo "âš ï¸ External health check timeout, but deployment may still be successful"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Server**: ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Application URL**: http://${{ secrets.EC2_HOST }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **API Documentation**: http://${{ secrets.EC2_HOST }}/swagger.html" >> $GITHUB_STEP_SUMMARY