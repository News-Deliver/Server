name: AWS EC2 ë°°í¬

on:
  push:
    branches: [ 'feat/git' ]  # feat/git ë¸Œëžœì¹˜ì—ì„œë§Œ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: EC2 ì„œë²„ì— ë°°í¬
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} '
            echo "ðŸš€ ë°°í¬ ì‹œìž‘ ì‹œê°„: $(date)"
            echo "ðŸ“ ë¸Œëžœì¹˜: ${{ github.ref_name }}"
            echo "ðŸ§ª feat/git ë¸Œëžœì¹˜ì˜ í…ŒìŠ¤íŠ¸ ë°°í¬ìž…ë‹ˆë‹¤"
          
            cd /opt/news-deliver
          
            # í˜„ìž¬ ë¸Œëžœì¹˜ í™•ì¸
            echo "ðŸ“‹ í˜„ìž¬ ë¸Œëžœì¹˜: $(git branch --show-current)"
          
            # feat/git ë¸Œëžœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ ë° í’€
            echo "ðŸ“¥ feat/gitì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin
            git checkout feat/git || git checkout -b feat/git origin/feat/git
            git pull origin feat/git
          
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f ".env" ]; then
              echo "âŒ .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
              exit 1
            fi
          
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            echo "ðŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker-compose down || true
          
            # Docker ì´ë¯¸ì§€ ì •ë¦¬
            echo "ðŸ§¹ ì˜¤ëž˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker system prune -f
          
            # ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹œìž‘
            echo "ðŸ”„ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œìž‘ ì¤‘..."
            docker-compose up -d --build
          
            # ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸°
            echo "â³ ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸° ì¤‘..."
            sleep 60
          
            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ðŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
            docker-compose ps
          
            # Spring Boot í—¬ìŠ¤ì²´í¬
            echo "ðŸ” Spring Boot í—¬ìŠ¤ì²´í¬ ì¤‘..."
            for i in {1..12}; do
              if curl -f http://localhost:8080/ >/dev/null 2>&1; then
                echo "âœ… Spring Bootê°€ ì •ìƒ ìž‘ë™ ì¤‘ìž…ë‹ˆë‹¤!"
                break
              fi
              echo "â³ ì‹œë„ $i/12: Spring Bootê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤..."
              sleep 10
            done
          
            echo "ðŸŽ‰ í…ŒìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ ì‹œê°„: $(date)"
          '

      - name: ì™¸ë¶€ í—¬ìŠ¤ì²´í¬
        run: |
          echo "ðŸ” ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ì¤‘..."
          sleep 30
          
          # ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸
          for i in {1..5}; do
            if curl -f http://${{ secrets.EC2_HOST }}:8080/ >/dev/null 2>&1; then
              echo "âœ… ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ í†µê³¼!"
              echo "ðŸ”— ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://${{ secrets.EC2_HOST }}:8080/"
              echo "ðŸ“‹ API ë¬¸ì„œ: http://${{ secrets.EC2_HOST }}:8080/swagger.html"
              echo "ðŸ§ª í…ŒìŠ¤íŠ¸ ë¸Œëžœì¹˜ì—ì„œ ë°°í¬ë¨: feat/git"
              exit 0
            fi
            echo "â³ ì‹œë„ $i/5: ì™¸ë¶€ ì²´í¬ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤..."
            sleep 10
          done
          
          echo "âš ï¸ ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ì‹œê°„ ì´ˆê³¼, í•˜ì§€ë§Œ ë°°í¬ëŠ” ì„±ê³µí–ˆì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤"

      - name: ë°°í¬ ìš”ì•½
        if: always()
        run: |
          echo "## ðŸ§ª í…ŒìŠ¤íŠ¸ ë°°í¬ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "- **ëŒ€ìƒ ì„œë²„**: ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°í¬ëœ ë¸Œëžœì¹˜**: feat/git (í…ŒìŠ¤íŠ¸ ì „ìš©)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°í¬ ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì• í”Œë¦¬ì¼€ì´ì…˜ URL**: http://${{ secrets.EC2_HOST }}:8080/" >> $GITHUB_STEP_SUMMARY
          echo "- **API ë¬¸ì„œ**: http://${{ secrets.EC2_HOST }}:8080/swagger.html" >> $GITHUB_STEP_SUMMARY
          echo "- **âš ï¸ ì°¸ê³ **: ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ ë°°í¬ìž…ë‹ˆë‹¤. í”„ë¡œë•ì…˜ì€ main ë¸Œëžœì¹˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY